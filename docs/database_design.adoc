= Tutor System - Database Design Specification
:toc:
:toclevels: 3
:sectnums:
:icons: font

== 1. Tổng quan & Quy ước (Overview)

* **Database Engine**: PostgreSQL (Khuyên dùng vì hỗ trợ Native Enum tốt) hoặc MySQL.
* **Naming Convention**: `snake_case` (tên bảng/cột viết thường, phân cách bằng gạch dưới).
* **Timezone**: Lưu trữ `TIMESTAMP` theo UTC.
* **Currency**: Tiền tệ lưu dạng `DECIMAL` (không dùng Float/Double để tránh sai số).

== 2. Các kiểu dữ liệu Enum (Enumeration Types)

Để đảm bảo tính nhất quán, các trường trạng thái và quyền hạn sẽ sử dụng kiểu ENUM định nghĩa trước.

[cols="1,3",options="header"]
|===
| Enum Name | Allowed Values

| `user_role`
| `USER`, `TUTOR`, `MANAGER`, `ADMIN`

| `user_status`
| `ACTIVE`, `BANNED`

| `profile_status`
| `PENDING` (Chờ duyệt), `APPROVED` (Đã duyệt), `REJECTED` (Từ chối)

| `booking_status`
| `PENDING`, `CONFIRMED`, `COMPLETED`, `CANCELLED`
|===

== 3. Sơ đồ Quan hệ Thực thể (ER Diagram)

[source,mermaid]
----
erDiagram
    user_app ||--o| TUTOR_PROFILES : "1-to-1"
    user_app ||--o{ BOOKINGS : "1-to-N (Student)"

    TUTOR_PROFILES ||--o{ BOOKINGS : "1-to-N (Tutor)"
    TUTOR_PROFILES ||--o{ CERTIFICATES : "1-to-N"
    TUTOR_PROFILES ||--o{ TUTOR_SUBJECTS : "1-to-N"

    SUBJECTS ||--o{ TUTOR_SUBJECTS : "1-to-N"

    user_app {
        BIGSERIAL id PK
        varchar email UK
        enum user_role
        enum user_status
    }

    TUTOR_PROFILES {
        BIGSERIAL id PK
        bigint user_id FK
        enum profile_status
        decimal hourly_rate
    }

    BOOKINGS {
        BIGSERIAL id PK
        enum booking_status
        datetime start_time
    }
----

== 4. Chi tiết Bảng (Schema Details)

=== 4.1. Nhóm Định Danh (Identity)

#### Table: `user_app`

Bảng gốc chứa thông tin đăng nhập cho mọi Role.

[cols="2,2,2,4",options="header"]
|===
| Column | Type | Constraints | Description

| `id`
| `BIGSERIAL`
| **PK**, Auto Increment
| Khóa chính.

| `email`
| `VARCHAR(100)`
| **Unique**, Not Null
| Email đăng nhập.

| `password_hash`
| `VARCHAR(255)`
| Not Null
| Mật khẩu đã mã hóa (BCrypt).

| `full_name`
| `VARCHAR(100)`
| Not Null
| Tên hiển thị người dùng.

| `phone`
| `VARCHAR(15)`
|
| Phone người dùng.

| `role`
| `ENUM: user_role`
| Not Null, Default `USER`
| Quyền hạn trong hệ thống.

| `status`
| `ENUM: user_status`
| Default `ACTIVE`
| Trạng thái hoạt động của tài khoản.

| `created_at`
| `TIMESTAMP`
| Default NOW()
| Thời gian tạo.
|===

=== 4.2. Nhóm Nghiệp Vụ Gia Sư (Tutor Core)

#### Table: `tutor_profiles`

Thông tin mở rộng cho User có role `TUTOR`.

[cols="2,2,2,4",options="header"]
|===
| Column | Type | Constraints | Description

| `id`
| `BIGSERIAL`
| **PK**, Auto Increment
| Khóa chính Profile.

| `user_id`
| `BIGINT`
| **FK** (`users.id`), **Unique**
| Liên kết 1-1 với Users.

| `bio`
| `TEXT`
| Nullable
| Giới thiệu bản thân.

| `hourly_rate`
| `DECIMAL(10,2)`
| Check > 0
| Giá thuê theo giờ (VNĐ).

| `experience_years`
| `INT`
| Check >= 0
| Số năm kinh nghiệm.

| `identity_card_url`
| `VARCHAR(500)`
| Nullable
| Link ảnh CCCD (Chỉ Manager thấy).

| `profile_status`
| `ENUM: profile_status`
| Default `PENDING`
| Trạng thái hồ sơ. Chỉ `APPROVED` mới hiện lên web.
|===

#### Table: `certificate`

Bằng cấp chứng chỉ của gia sư.

[cols="2,2,2,4",options="header"]
|===
| Column | Type | Constraints | Description

| `id`
| `BIGSERIAL`
| **PK**, Auto Increment
| ID Chứng chỉ.

| `tutor_profile_id`
| `BIGINT`
| **FK** (`tutor_profiles.id`)
| Thuộc về hồ sơ nào.

| `name`
| `VARCHAR(200)`
| Not Null
| Tên bằng (VD: IELTS 8.0).

| `image_url`
| `VARCHAR(500)`
| Not Null
| Link ảnh bằng cấp.
|===

#### Table: `subject`

Danh mục môn học hệ thống hỗ trợ.

[cols="2,2,2,4",options="header"]
|===
| Column | Type | Constraints | Description

| `id`
| `SERIAL`
| **PK**, Auto Increment
| ID Môn học (Dùng INT là đủ).

| `name`
| `VARCHAR(100)`
| **Unique**, Not Null
| Tên môn (Toán, Lý, Hóa...).
|===

#### Table: `tutor_subject`

Bảng trung gian: Gia sư dạy những môn nào.

[cols="2,2,2,4",options="header"]
|===
| Column | Type | Constraints | Description

| `tutor_profile_id`
| `BIGINT`
| **PK, FK**
| ID Gia sư.

| `subject_id`
| `INT`
| **PK, FK**
| ID Môn học.
|===

=== 4.3. Nhóm Giao Dịch (Transaction)

#### Table: `booking`

Lưu trữ lịch thuê gia sư.

[cols="2,2,2,4",options="header"]
|===
| Column | Type | Constraints | Description

| `id`
| `BIGSERIAL`
| **PK**, Auto Increment
| Mã Booking.

| `user_id`
| `BIGINT`
| **FK** (`users.id`)
| Người đi thuê (Học viên).

| `tutor_profile_id`
| `BIGINT`
| **FK** (`tutor_profiles.id`)
| Người dạy.

| `start_time`
| `TIMESTAMP`
| Not Null
| Thời gian bắt đầu.

| `end_time`
| `TIMESTAMP`
| Not Null
| Thời gian kết thúc.

| `status`
| `ENUM: booking_status`
| Default `PENDING`
| Trạng thái lịch hẹn.

| `note`
| `TEXT`
| Nullable
| Ghi chú của học viên.
|===

== 5. Quy tắc Nghiệp vụ Database (Business Rules)

1. **Ràng buộc duy nhất (Uniqueness)**:
* Mỗi `email` chỉ được đăng ký 1 lần.
* Mỗi User chỉ có tối đa 1 `TutorProfile`.

2. **Quy tắc duyệt (Validation Logic)**:
* Gia sư mới tạo tài khoản -> `profile_status = PENDING`.
* API Search chỉ query các bản ghi có `profile_status = APPROVED`.

3. **Quy tắc đặt lịch (Booking Logic)**:
* `start_time` phải nhỏ hơn `end_time`.
* Hệ thống phải chặn việc tạo `booking` mới nếu khoảng thời gian (`start`, `end`) bị trùng lặp (Overlap) với một booking đã `CONFIRMED` của cùng `tutor_profile_id`.